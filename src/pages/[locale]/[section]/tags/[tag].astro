---
import BaseLayout from '@layouts/BaseLayout.astro'
import Tags from '@components/Tags.astro'
import ListPost from '@components/ListPost.astro'
import ListWork from '@components/ListWork.astro'
import { useTranslations } from '@i18n/utils'
import type { UILanguages } from '@i18n/ui'
import { buildTagPaths } from '@utils/staticPathsBuilder'
import { buildTagsPageContext } from '@utils/sectionContext'

export async function getStaticPaths() {
  return await buildTagPaths()
}

const { locale, section, tag } = Astro.params as { locale: UILanguages; section: string; tag: string }
const propsTag = Astro.props?.tag
const t = useTranslations(locale)

// Construir contexto de página (valida sección y carga posts)
const context = await buildTagsPageContext(
  section,
  locale,
  tag,
  propsTag,
  Astro.props ? { posts: Astro.props.posts ?? [], tags: Astro.props.tags ?? [] } : undefined
)

const { config, posts, tags } = context
const Component = config.listComponent === 'ListWork' ? ListWork : ListPost

const pageTitle = `${t(config.translationKey)} - ${tag}`
const metaDescription = `${config.taggedKey ? t(config.taggedKey) : t(config.translationKey)} ${tag}`
---

<head>
  <meta charset="utf-8" />
  <title>{pageTitle}</title>
  <meta name="description" content={metaDescription} />
</head>

<BaseLayout pageTitle={pageTitle}>
  <Tags route={`/${locale}/${section}/tags/`} tags={tags} current={tag} />
  {config.taggedKey && <p>{t(config.taggedKey)} {tag}</p>}

  {posts.length === 0 ? (
    <div class="warning">
      <p>{t('tags.untranslated_notice')}</p>
    </div>
  ) : (
    <div>
      <Component posts={posts} basePath={`${locale}/${config.routes[locale]}`} lang={locale} />
    </div>
  )}
</BaseLayout>
