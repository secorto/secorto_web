---
import { render, getCollection } from 'astro:content'
import type { CollectionEntry, CollectionKey } from 'astro:content'
import BaseLayout from '@layouts/BaseLayout.astro'
import Comments from '@components/Comments.astro'
import BlogTalkPostView from '@components/BlogTalkPostView.astro'
import WorkProjectCommunityView from '@components/WorkProjectCommunityView.astro'
import SEOHeadDetail from '@components/SEOHeadDetail.astro'
import { loadEntryByRoute } from '@utils/sectionLoader'
import { useTranslations } from '@i18n/utils'
import type { UILanguages } from '@i18n/ui'
import { buildDetailPageContext } from '@utils/sectionContext'
import { getAvailableLocalesForEntry } from '@utils/translationHelpers'
import { getCanonicalMetadata, getPageMetadata } from '@utils/translationMetadata'
import { buildAllDetailPaths } from '@utils/staticPathsBuilder'

interface BaseEntryData {
  title: string
  translation_status?: 'original' | 'translated' | 'draft' | 'partial' | 'pending'
  translation_origin?: { locale: string; id: string }
  slug?: string
}

export async function getStaticPaths() {
  return await buildAllDetailPaths(getCollection)
}

const { locale, section, id } = Astro.params as { locale: UILanguages; section: string; id: string }
const t = useTranslations(locale)

// Construir contexto de p√°gina (intenta cargar, con fallback a otros locales)
const context = await buildDetailPageContext(section, locale, id, loadEntryByRoute)

if (!context) {
  return new Response('Not found', { status: 404 })
}

const { entry, config, cleanId } = context
const entryTyped = entry as CollectionEntry<CollectionKey>
const entryData = entryTyped.data as BaseEntryData

// Calculate canonical metadata (handles translation drafts)
const { isTranslationDraft, canonicalLocale, canonicalId, shouldNoindex } = getCanonicalMetadata({
  translationStatus: entryData.translation_status,
  translationOrigin: entryData.translation_origin,
  currentLocale: context.locale,
  currentCleanId: cleanId
})

// Get available locales for hreflang
const availableLocales = await getAvailableLocalesForEntry(config.collection, cleanId)

// Extract page metadata
const { Content } = await render(entryTyped)
const { pageTitle, pageDescription } = getPageMetadata(entryTyped, t(config.translationKey))
const routeSlug = config.routes[context.locale]
---

<SEOHeadDetail
  slot="seo-head"
  config={config}
  cleanId={canonicalId}
  canonicalLocale={canonicalLocale}
  availableLocales={availableLocales}
  noindex={shouldNoindex}
/>

<BaseLayout pageTitle={pageTitle} description={pageDescription}>
  {isTranslationDraft && entryData.translation_origin && (
    <div class="untranslated-notice" role="status">
      <p>{t('post.translation_draft_notice')}</p>
      <a href={`/${entryData.translation_origin.locale}/${config.routes[entryData.translation_origin.locale as UILanguages]}/${entryData.translation_origin.id}`}>{t('post.view_original')}</a>
    </div>
  )}

  {config.detailComponent === 'BlogTalkPostView' ? (
    <BlogTalkPostView
      locale={context.locale}
      routeSlug={routeSlug}
      entry={entryTyped}
      hasTags={config.hasTags}
      Content={Content}
    />
  ) : (
    <WorkProjectCommunityView
      locale={context.locale}
      entry={entryTyped}
      Content={Content}
    />
  )}

  <Comments />
</BaseLayout>
