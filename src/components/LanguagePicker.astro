---
import { translations } from "../i18n/translations";
import { languages, languageKeys, defaultLang, showDefaultLang } from "../i18n/ui";
import type { UILanguages } from "../i18n/ui";
import { resolveCanonical, resolveLocalized } from "../i18n/rootMap";
import { useTranslations } from "@i18n/utils"

const segments = Astro.url.pathname.split("/").filter(Boolean);
const lang = segments[0] as UILanguages;
const rawSection = segments[1];
const slug = segments.slice(2).join("/");

const canonicalSection = resolveCanonical(rawSection, lang);
const isDetailPage = Boolean(slug);

const t = useTranslations(lang as UILanguages)

const availableLocales = isDetailPage
  ? translations[canonicalSection as keyof typeof translations]?.[slug] || {}
  : {};

const isTagPage = slug.startsWith("tags");
---

<div class="language-picker">
  {languageKeys.map((targetLang) => {
    const label = languages[targetLang];
    const langPrefix =
      targetLang === defaultLang && !showDefaultLang ? "" : `/${targetLang}`;
    const localizedSection = resolveLocalized(canonicalSection, targetLang);


    // ğŸ“Œ Caso 1: pÃ¡gina de tags (sin traducciÃ³n de "tag")
    if (isTagPage) {
      return <a href={`${langPrefix}/${localizedSection}/${slug}`}>{label}</a>;
    }

    // ğŸ“Œ Caso 2: pÃ¡ginas de detalle dentro de colecciones
    if (isDetailPage && canonicalSection in translations) {
      const entry = availableLocales[targetLang];
  if (!entry) {
        // Tipado ligero para metadata de la entrada
        interface EntryMeta {
          noTranslate?: string[]
        }

        const meta = translations[canonicalSection as keyof typeof translations]?.[slug] as EntryMeta | undefined
        const willNotBeTranslated =
          Array.isArray(meta?.noTranslate) && meta!.noTranslate!.includes(targetLang)

        const note = willNotBeTranslated
          ? "Esta publicaciÃ³n no serÃ¡ traducida"
          : "La traducciÃ³n no estÃ¡ disponible todavÃ­a"

        return (
          <span
            class="disabled"
            role="link"
            aria-disabled="true"
            tabindex="-1"
            aria-label={`${note}: ${label}`}
            title={`${note}: ${label}`}
            data-disabled-reason={willNotBeTranslated ? "no-translate" : "not-yet-translated"}
          >
            {label} {willNotBeTranslated ? "ğŸ”’" : "âŒ›"}
          </span>
        )
      }
      // If entry exists but is a draft/partial translation, indicate in the picker
      const status = (entry as any).translation_status as string | undefined
      if (status && status !== 'translated') {
        const note = status === 'draft' ? t('post.translation_draft_notice') : t('post.translation_pending')
        const marker = status === 'draft' ? 'âœï¸' : 'âŒ›'
        return (
          <a href={`${langPrefix}/${localizedSection}/${entry.slug}`} title={`${note}: ${label}`} aria-label={`${note}: ${label}`}>
            {label} {marker}
          </a>
        )
      }

      return (
        <a href={`${langPrefix}/${localizedSection}/${entry.slug}`}>
          {label}
        </a>
      );
    }

    // ğŸ“Œ Caso 3: Ã­ndice de colecciÃ³n (ej. /es/blog) o pÃ¡ginas estÃ¡ticas (ej. /es/about)
    return <a href={`${langPrefix}/${localizedSection}`}>{label}</a>;
  })}
</div>
