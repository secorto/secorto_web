---
import { translations } from "../i18n/translations";
import { languages, languageKeys, defaultLang, showDefaultLang } from "../i18n/ui";
import type { UILanguages } from "../i18n/ui";
import { resolveCanonical, resolveLocalized } from "../i18n/rootMap";
import { useTranslations } from "@i18n/utils"

// === PARSING DE URL ===
const segments = Astro.url.pathname.split("/").filter(Boolean);
const currentLang = segments[0] as UILanguages;
const rawSection = segments[1];
const slug = segments.slice(2).join("/");

// === DETECCI√ìN DE TIPO DE P√ÅGINA ===
const isHomePage = !rawSection;
const isTagPage = slug.startsWith("tags");
const isDetailPage = Boolean(slug) && !isHomePage;
const isCollectionIndexPage = !isDetailPage && !isHomePage;

// === RESOLUCI√ìN DE SECCI√ìN CAN√ìNICA ===
const canonicalSection = isHomePage ? "" : resolveCanonical(rawSection, currentLang);

// === DATOS DISPONIBLES ===
const t = useTranslations(currentLang as UILanguages);
const availableLocales = isDetailPage
  ? translations[canonicalSection as keyof typeof translations]?.[slug] || {}
  : {};

// === TIPOS AUXILIARES ===
interface EntryMeta {
  noTranslate?: string[]
}

interface TranslationLink {
  href: string
  label: string
  title?: string
  aria?: string
  isAvailable: boolean
  disabledReason?: 'not-available' | 'no-translate'
  marker?: string
}

// === FUNCIONES DE GENERACI√ìN DE URLs Y LINKS ===

/** Construye el prefijo de idioma (/es, /en, o vac√≠o si es default sin prefijo) */
function buildLangPrefix(targetLang: UILanguages): string {
  return targetLang === defaultLang && !showDefaultLang ? "" : `/${targetLang}`;
}

/** Construye un link para la p√°gina de inicio */
function buildHomePageLink(targetLang: UILanguages): TranslationLink {
  return {
    href: `${buildLangPrefix(targetLang)}/`,
    label: languages[targetLang],
    isAvailable: true
  };
}

/** Construye un link para p√°gina de tags */
function buildTagPageLink(targetLang: UILanguages): TranslationLink {
  const localizedSection = resolveLocalized(canonicalSection, targetLang);
  return {
    href: `${buildLangPrefix(targetLang)}/${localizedSection}/${slug}`,
    label: languages[targetLang],
    isAvailable: true
  };
}

/** Determina por qu√© una traducci√≥n no est√° disponible */
function getDisabledReasonForLang(targetLang: UILanguages): 'not-available' | 'no-translate' {
  const meta = translations[canonicalSection as keyof typeof translations]?.[slug] as EntryMeta | undefined;
  const willNotBeTranslated = Array.isArray(meta?.noTranslate) && meta!.noTranslate!.includes(targetLang);
  return willNotBeTranslated ? 'no-translate' : 'not-available';
}

const DISABLED_REASON_CONFIG: Record<'not-available' | 'no-translate', {
  marker: string
  title: string
}> = {
  'not-available': {
    marker: '‚åõ',
    title: 'La traducci√≥n no est√° disponible todav√≠a'
  },
  'no-translate': {
    marker: 'üîí',
    title: 'Esta publicaci√≥n no ser√° traducida'
  }
}

/** Construye un link para p√°gina de detalle (post/charla/proyecto/etc) */
function buildDetailPageLink(targetLang: UILanguages): TranslationLink {
  const entry = availableLocales[targetLang];
  const localizedSection = resolveLocalized(canonicalSection, targetLang);
  
  if (!entry) {
    const disabledReason = getDisabledReasonForLang(targetLang);
    const config = DISABLED_REASON_CONFIG[disabledReason];
    
    return {
      href: '',
      label: languages[targetLang],
      isAvailable: false,
      disabledReason,
      marker: config.marker,
      title: config.title,
      aria: `${config.title}: ${languages[targetLang]}`
    };
  }
  
  return {
    href: `${buildLangPrefix(targetLang)}/${localizedSection}/${entry.slug}`,
    label: languages[targetLang],
    isAvailable: true
  };
}

/** Construye un link para √≠ndice de colecci√≥n o p√°gina est√°tica */
function buildCollectionIndexLink(targetLang: UILanguages): TranslationLink {
  const localizedSection = resolveLocalized(canonicalSection, targetLang);
  return {
    href: `${buildLangPrefix(targetLang)}/${localizedSection}`,
    label: languages[targetLang],
    isAvailable: true
  };
}

/** Determina qu√© tipo de link generar y lo construye */
function buildLinkForLang(targetLang: UILanguages): TranslationLink {
  if (isHomePage) return buildHomePageLink(targetLang);
  if (isTagPage) return buildTagPageLink(targetLang);
  if (isDetailPage) return buildDetailPageLink(targetLang);
  return buildCollectionIndexLink(targetLang);
}
---

<div class="language-picker">
  {languageKeys.map((targetLang) => {
    const link = buildLinkForLang(targetLang);
    const text = `${link.label}${link.marker ? ` ${link.marker}` : ''}`;
    
    if (!link.isAvailable) {
      return (
        <span
          class="disabled"
          role="link"
          aria-disabled="true"
          tabindex="-1"
          aria-label={link.aria}
          title={link.title}
          data-disabled-reason={link.disabledReason}
        >
          {text}
        </span>
      );
    }
    
    return (
      <a
        href={link.href}
        title={link.title}
        aria-label={link.aria}
      >
        {text}
      </a>
    );
  })}
</div>
